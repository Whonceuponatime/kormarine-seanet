<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Network Demo ‚Äî LED Visualization</title>
<style>
  :root { 
    --bg: #f8fafc; 
    --card: #ffffff; 
    --muted: #64748b; 
    --accent: #0ea5e9; 
    --danger: #ef4444;
    --success: #10b981;
    --warning: #f59e0b;
    --border: #e2e8f0;
    --text: #1e293b;
    --text-light: #64748b;
  }
  
  html,body { height:100%; margin:0; }
  body { 
    background: var(--bg); 
    color: var(--text); 
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif; 
    display:flex; 
    flex-direction:column;
    line-height: 1.6;
  }
  
  header { 
    padding: 16px 20px; 
    border-bottom: 1px solid var(--border); 
    background: var(--card); 
    display:flex; 
    align-items:center; 
    gap:16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  header h1 { 
    margin:0; 
    font-size: 20px;
    font-weight: 600;
    color: var(--text);
  }
  
  .tabs { display:flex; gap:8px; margin-left:auto; }
  .tab { 
    background: var(--bg); 
    border: 1px solid var(--border); 
    color: var(--text-light); 
    padding: 10px 16px; 
    border-radius: 12px; 
    cursor:pointer; 
    font-weight: 500;
    transition: all 0.2s ease;
  }
  .tab:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
  }
  .tab.active { 
    background: var(--accent); 
    border-color: var(--accent); 
    color: white;
    box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
  }

  main { flex:1; min-height:0; display:flex; }
  .card { 
    flex:1; 
    min-height:0; 
    display:flex; 
    flex-direction:column; 
    gap: 16px; 
    padding: 20px; 
  }
  
  .panel { 
    background: var(--card); 
    border: 1px solid var(--border); 
    border-radius: 16px; 
    padding: 20px; 
    display: flex; 
    flex-direction: column; 
    min-height: 0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  .stage-wrap { flex:1; min-height:0; display:flex; }
  .stage { 
    flex:1; 
    width:100%; 
    height:100%; 
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); 
    border: 1px solid var(--border); 
    border-radius: 16px;
    padding: 20px;
  }

  .legend { 
    display:flex; 
    gap: 16px; 
    align-items:center; 
    color: var(--text-light); 
    font-weight: 500;
    margin-bottom: 12px;
  }
  
  .badge { 
    display:inline-flex; 
    align-items:center; 
    gap: 8px; 
    padding: 8px 12px; 
    border-radius: 20px; 
    font-size: 13px; 
    border: 1px solid var(--border); 
    background: var(--card);
    font-weight: 500;
  }
  
  .req { 
    color: #dc2626; 
    border-color: #fecaca; 
    background: #fef2f2;
  }
  
  .res { 
    color: var(--success); 
    border-color: #bbf7d0; 
    background: #f0fdf4;
  }
  
  .ping { 
    color: #ea580c; 
    border-color: #fed7aa; 
    background: #fff7ed;
  }

  .node { 
    fill: var(--card); 
    stroke: var(--accent); 
    stroke-width: 3;
    filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
  }
  
  .node-label { 
    fill: var(--text); 
    font-weight: 600; 
    font-size: 16px;
  }
  
  .controls { 
    display:flex; 
    gap: 12px; 
    flex-wrap:wrap; 
    align-items:center;
    margin-top: 16px;
  }
  
  .dotbar { 
    display:flex; 
    gap: 10px; 
    flex-wrap:wrap;
    padding: 12px;
    background: var(--bg);
    border-radius: 12px;
    border: 1px solid var(--border);
  }
  
  .dot { 
    width: 20px; 
    height: 20px; 
    border-radius: 50%; 
    background: var(--card); 
    border: 2px solid var(--border); 
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    position: relative;
  }
  
  .dot::after {
    content: attr(title);
    position: absolute;
    bottom: -25px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: var(--text-light);
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.2s ease;
  }
  
  .dot:hover::after {
    opacity: 1;
  }
  
  .dot.on { 
    background: var(--success); 
    border-color: var(--success);
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.4), inset 0 2px 4px rgba(0,0,0,0.1);
    transform: scale(1.1);
  }
  
  .dot.r.on { 
    background: var(--danger); 
    border-color: var(--danger);
    box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
  }
  
  button { 
    background: var(--card); 
    border: 1px solid var(--border); 
    color: var(--text); 
    padding: 12px 18px; 
    border-radius: 12px; 
    cursor: pointer; 
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  button:hover { 
    border-color: var(--accent);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
  }
  
  button.accent { 
    background: var(--accent); 
    border-color: var(--accent); 
    color: white;
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
  }
  
  button.accent:hover {
    background: #0284c7;
    box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4);
  }
  
  button.danger { 
    background: var(--danger); 
    border-color: var(--danger); 
    color: white;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }
  
  button.danger:hover {
    background: #dc2626;
    box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
  }
  
  button.success {
    background: var(--success);
    border-color: var(--success);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }
  
  button.success:hover {
    background: #059669;
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
  }
  
  input, select { 
    background: var(--card); 
    color: var(--text); 
    border: 1px solid var(--border); 
    border-radius: 12px; 
    padding: 12px 16px;
    font-size: 14px;
    transition: all 0.2s ease;
  }
  
  input:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
  }
  
  .status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    background: var(--success);
    color: white;
    margin-left: auto;
  }
  
  .status-indicator.offline {
    background: var(--danger);
  }
  
  .interface-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--bg);
    margin-top: 12px;
  }
  
  .interface-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    transition: background 0.2s ease;
  }
  
  .interface-item:hover {
    background: var(--card);
  }
  
  .interface-item:last-child {
    border-bottom: none;
  }
  
  .interface-info {
    flex: 1;
  }
  
  .interface-name {
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
  }
  
  .interface-status {
    font-size: 12px;
    color: var(--text-light);
  }
  
  .status-up {
    color: var(--success);
  }
  
  .status-down {
    color: var(--danger);
  }
  
  .interface-actions {
    display: flex;
    gap: 8px;
  }
  
  .loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--border);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1s ease-in-out infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .section-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
</style>
</head>
<body>
  <header>
    <h1>üåê Network Demo ‚Äî LED Visualization</h1>
    <div class="status-indicator" id="status">
      <span>‚óè</span> Online
    </div>
  <div class="tabs">
    <div class="tab active" data-tab="demo" onclick="showTab('demo', this)">Demo</div>
    <div class="tab" data-tab="settings" onclick="showTab('settings', this)">Settings</div>
  </div>
</header>

<main>
  <div class="card">
    <!-- VISUAL PANEL -->
    <div id="demo" class="panel section active">
      <div class="legend">
        <span class="badge req">‚û° Request (Red)</span>
        <span class="badge res">‚¨Ö Response (Green)</span>
        <span class="badge ping">‚Ä¢ Ping (Orange)</span>
      </div>

      <div class="stage-wrap">
        <svg class="stage" viewBox="0 0 1100 560" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <filter id="glow">
              <feGaussianBlur stdDeviation="4" result="g"/>
              <feMerge>
                <feMergeNode in="g"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
            <linearGradient id="nodeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#f1f5f9;stop-opacity:1" />
            </linearGradient>
            <path id="p_req" d="M160,220 C420,40 680,40 940,220" fill="none" stroke="none"/>
            <path id="p_res" d="M940,340 C680,520 420,520 160,340" fill="none" stroke="none"/>
          </defs>

          <!-- Background grid -->
          <defs>
            <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
              <path d="M 50 0 L 0 0 0 50" fill="none" stroke="#e2e8f0" stroke-width="1" opacity="0.3"/>
            </pattern>
          </defs>
          <rect width="100%" height="100%" fill="url(#grid)" />

          <rect x="100" y="230" rx="16" ry="16" width="160" height="100" class="node" fill="url(#nodeGradient)"/>
          <text x="180" y="285" text-anchor="middle" class="node-label">Attacker</text>
          <rect x="840" y="230" rx="16" ry="16" width="160" height="100" class="node" fill="url(#nodeGradient)"/>
          <text x="920" y="285" text-anchor="middle" class="node-label">Target</text>

          <use href="#p_req" stroke="#cbd5e1" stroke-width="4" stroke-dasharray="8 8"/>
          <use href="#p_res" stroke="#cbd5e1" stroke-width="4" stroke-dasharray="8 8"/>

          <circle id="pkt_req" r="12" class="packet" fill="#dc2626" style="opacity:0; filter:url(#glow)">
            <animateMotion id="am_req" dur="1.2s" fill="freeze" path="M160,220 C420,40 680,40 940,220"/>
          </circle>
          <circle id="pkt_res" r="12" class="packet" fill="#10b981" style="opacity:0; filter:url(#glow)">
            <animateMotion id="am_res" dur="1.2s" fill="freeze" path="M940,340 C680,520 420,520 160,340"/>
          </circle>
        </svg>
      </div>

      <div class="controls">
        <div class="dotbar">
          <div id="d17" class="dot r" title="GPIO17"></div>
          <div id="d27" class="dot" title="GPIO27"></div>
          <div id="d22" class="dot" title="GPIO22"></div>
          <div id="d10" class="dot" title="GPIO10"></div>
          <div id="d09" class="dot" title="GPIO9"></div>
          <div id="d5" class="dot" title="GPIO5"></div>
          <div id="d6" class="dot" title="GPIO6"></div>
        </div>
        <button class="accent" onclick="sendReqResp()">Send Packet</button>
        <button style="background: #f59e0b; border-color: #f59e0b; color: white; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);" onclick="doPing()">Ping Target</button>
      </div>

             <div class="controls">
         <input id="target" placeholder="Target IP Address" style="min-width: 200px;">
         <button onclick="doPing()">Ping</button>
       </div>

       <!-- SNMP Section -->
       <div class="section-title" style="margin-top: 24px; border-top: 1px solid var(--border); padding-top: 16px;">
         üîß SNMP Network Management
       </div>
       
       <div class="controls">
         <input id="snmp_target" placeholder="SNMP Target IP" style="min-width: 180px;">
         <input id="snmp_ro" placeholder="RO Community" value="public" style="width: 120px;">
         <input id="snmp_rw" placeholder="RW Community" value="private" style="width: 120px;">
         <button class="accent" onclick="discoverInterfaces()">üîç Discover Interfaces</button>
         <button onclick="snmpWalk()">üìã SNMP Walk</button>
       </div>

       <div class="controls" style="margin-top: 12px;">
         <input id="manual_ifindex" placeholder="Interface Index (e.g. 7)" style="width: 160px;">
         <button class="danger" onclick="snmpPortDown()">üî¥ Port Down (LED: 1‚Üí2‚Üí3‚Üí4‚Üí5)</button>
         <button class="success" onclick="snmpPortUp()">üü¢ Port Up (LED: 5‚Üí4‚Üí3‚Üí2‚Üí1)</button>
       </div>

       <!-- Output Display Area -->
       <div id="output_container" style="margin-top: 16px; display: none;">
         <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
           üìä Output Data
           <button onclick="clearOutput()" style="padding: 6px 12px; font-size: 12px; background: var(--muted); border-color: var(--muted); color: white;">Clear</button>
         </div>
         <div id="output_area" style="
           background: var(--bg); 
           border: 1px solid var(--border); 
           border-radius: 12px; 
           padding: 16px; 
           max-height: 300px; 
           overflow-y: auto; 
           font-family: 'Courier New', monospace; 
           font-size: 13px; 
           line-height: 1.4;
           white-space: pre-wrap;
           color: var(--text);
         "></div>
       </div>

       <!-- Interface List -->
       <div id="interface_container" style="margin-top: 16px; display: none;">
         <div class="section-title">üåê Discovered Interfaces</div>
         <div class="interface-list" id="interface_list">
           <!-- Interfaces will be populated here -->
         </div>
       </div>
     </div>

    

    <!-- SETTINGS PANEL -->
    <div id="settings" class="panel section" style="display:none">
      <div class="section-title">
        ‚öôÔ∏è LED Control Panel
      </div>
      <div class="controls">
        <button onclick="fetch('/on17')">ON 17</button>
        <button onclick="fetch('/on27')">ON 27</button>
        <button onclick="fetch('/on22')">ON 22</button>
        <button onclick="fetch('/on10')">ON 10</button>
        <button onclick="fetch('/on9')">ON 9</button>
        <button onclick="fetch('/on5')">ON 5</button>
        <button onclick="fetch('/on6')">ON 6</button>
        <button onclick="fetch('/off')">All OFF</button>
      </div>
      <div class="controls">
        <label style="font-weight: 500; color: var(--text);">Wave Speed:</label>
        <select id="hz">
          <option value="1">1 Hz</option>
          <option value="2">2 Hz</option>
          <option value="3">3 Hz</option>
          <option value="5">5 Hz</option>
        </select>
        <button class="accent" onclick="startWave()">Start Wave</button>
        <button onclick="stopWave()">Stop</button>
      </div>
      <div style="opacity: 0.7; font-size: 13px; margin-top: 12px; color: var(--text-light);">
        üí° Settings tab is for LED testing. Demo tab focuses on network operations.
      </div>
    </div>
  </div>
</main>

<script>
// Colors: updated for light mode
function setPacketColors(reqColor, resColor){
  document.getElementById('pkt_req').setAttribute('fill', reqColor);
  document.getElementById('pkt_res').setAttribute('fill', resColor);
}

function showTab(id, btn){
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='flex';
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
}

function startWave(){ 
  const hz=document.getElementById('hz').value; 
  fetch('/start?hz='+hz); 
}

function stopWave(){ 
  fetch('/stop'); 
}

// Fixed packet animation synchronization
function sendReqResp(){
  setPacketColors('#dc2626', '#10b981');
  const req = document.getElementById('pkt_req');
  const res = document.getElementById('pkt_res');
  const amReq = document.getElementById('am_req');
  const amRes = document.getElementById('am_res');
  
  // Reset animations
  req.style.opacity = 0;
  res.style.opacity = 0;
  
  // Start request packet
  req.style.opacity = 1;
  amReq.beginElement();
  fetch('/demo/packet', {method:'POST'});
  
  // Start response packet after request completes
  setTimeout(() => {
    res.style.opacity = 1;
    amRes.beginElement();
  }, 1200); // Match the animation duration
  
  // Hide packets after completion
  setTimeout(() => {
    req.style.opacity = 0;
    res.style.opacity = 0;
  }, 2400);
}

 function doPing(){
   const t = document.getElementById('target').value.trim();
   if(!t){ 
     alert('Please enter a target IP address'); 
     return; 
   }
   
   setPacketColors('#ea580c', '#ea580c'); // Both orange for ping
   const req = document.getElementById('pkt_req');
   const res = document.getElementById('pkt_res');
   const amReq = document.getElementById('am_req');
   const amRes = document.getElementById('am_res');
   
   // Reset animations
   req.style.opacity = 0;
   res.style.opacity = 0;
   
   // Start request packet
   req.style.opacity = 1;
   amReq.beginElement();
   
   // Show output area
   showOutput(`Pinging ${t}...\n`);
   
   fetch('/ping?target='+encodeURIComponent(t))
     .then(r=>r.json())
     .then(data => {
       // Display ping results
       if(data.ok) {
         showOutput(`‚úÖ Ping successful!\nResponse: ${data.output}\n`);
       } else {
         showOutput(`‚ùå Ping failed: ${data.error}\n`);
       }
       
       // Start response packet after ping completes
       setTimeout(() => {
         res.style.opacity = 1;
         amRes.beginElement();
       }, 1200);
     })
     .catch(err => {
       console.error('Ping failed:', err);
       showOutput(`‚ùå Ping error: ${err.message}\n`);
       // Still show response animation for visual feedback
       setTimeout(() => {
         res.style.opacity = 1;
         amRes.beginElement();
       }, 1200);
     })
     .finally(() => {
       // Reset colors and hide packets
       setTimeout(() => {
         req.style.opacity = 0;
         res.style.opacity = 0;
         setPacketColors('#dc2626', '#10b981');
       }, 2400);
     });
 }

// SNMP Functions
 function discoverInterfaces() {
   const target = document.getElementById('snmp_target').value.trim();
   const community = document.getElementById('snmp_ro').value.trim();
   
   if(!target) {
     alert('Please enter a target IP address');
     return;
   }
   
   const container = document.getElementById('interface_container');
   const list = document.getElementById('interface_list');
   
   // Show loading and output
   container.style.display = 'block';
   showOutput(`üîç Discovering interfaces on ${target}...\n`);
   list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-light);"><div class="loading"></div> Discovering interfaces...</div>';
   
   fetch('/snmp/interfaces?target='+encodeURIComponent(target)+'&community='+encodeURIComponent(community))
     .then(r => r.json())
     .then(data => {
       if(data.ok) {
         showOutput(`‚úÖ Interface discovery successful!\nFound ${Object.keys(data.interfaces.names || {}).length} interfaces\n`);
         displayInterfaces(data.interfaces, target, community);
       } else {
         showOutput(`‚ùå Interface discovery failed: ${data.error || 'Unknown error'}\n`);
         list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">‚ùå Failed to discover interfaces: ' + (data.error || 'Unknown error') + '</div>';
       }
     })
     .catch(err => {
       console.error('Interface discovery failed:', err);
       showOutput(`‚ùå Interface discovery error: ${err.message}\n`);
       list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">‚ùå Interface discovery failed</div>';
     });
 }

function displayInterfaces(interfaces, target, community) {
  const list = document.getElementById('interface_list');
  
  try {
    // Parse SNMP output to extract interface information
    const names = parseSnmpOutput(interfaces.names);
    const adminStatus = parseSnmpOutput(interfaces.admin_status);
    const operStatus = parseSnmpOutput(interfaces.oper_status);
    
    let html = '';
    
    for(let i = 1; i <= Math.max(names.length, adminStatus.length, operStatus.length); i++) {
      const name = names[i] || `Interface ${i}`;
      const admin = adminStatus[i] || 'unknown';
      const oper = operStatus[i] || 'unknown';
      
      const adminText = admin === '1' ? 'Up' : admin === '2' ? 'Down' : 'Unknown';
      const operText = oper === '1' ? 'Up' : oper === '2' ? 'Down' : 'Unknown';
      
      const adminClass = admin === '1' ? 'status-up' : admin === '2' ? 'status-down' : '';
      const operClass = oper === '1' ? 'status-up' : oper === '2' ? 'status-down' : '';
      
      html += `
        <div class="interface-item">
          <div class="interface-info">
            <div class="interface-name">${name}</div>
            <div class="interface-status">
              Admin: <span class="${adminClass}">${adminText}</span> | 
              Oper: <span class="${operClass}">${operText}</span>
            </div>
          </div>
                     <div class="interface-actions">
             <button class="danger" style="padding: 6px 12px; font-size: 12px;" onclick="snmpPortDown('${target}', '${community}', '${i}')" title="LED Pattern: 1‚Üí2‚Üí3‚Üí4‚Üí5">Down</button>
             <button class="success" style="padding: 6px 12px; font-size: 12px;" onclick="snmpPortUp('${target}', '${community}', '${i}')" title="LED Pattern: 5‚Üí4‚Üí3‚Üí2‚Üí1">Up</button>
           </div>
        </div>
      `;
    }
    
    if(html === '') {
      html = '<div style="padding: 20px; text-align: center; color: var(--text-light);">No interfaces found</div>';
    }
    
    list.innerHTML = html;
  } catch(err) {
    console.error('Error parsing interfaces:', err);
    list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">‚ùå Error parsing interface data</div>';
  }
}

function parseSnmpOutput(output) {
  const result = {};
  const lines = output.split('\n');
  
  for(const line of lines) {
    const match = line.match(/\.(\d+)\s*=\s*(.+)$/);
    if(match) {
      const index = match[1];
      let value = match[2].trim();
      
      // Remove quotes if present
      if(value.startsWith('"') && value.endsWith('"')) {
        value = value.slice(1, -1);
      }
      
      result[index] = value;
    }
  }
  
  return result;
}

 function snmpPortDown(target = null, community = null, ifindex = null) {
   const t = target || document.getElementById('snmp_target').value.trim();
   const c = community || document.getElementById('snmp_rw').value.trim();
   const i = ifindex || document.getElementById('manual_ifindex').value.trim();
   
   if(!t || !i) {
     alert('Please enter both target IP and interface index');
     return;
   }
   
   showOutput(`üî¥ Setting port ${i} DOWN on ${t}...\n`);
   
   fetch('/snmp/portdown?target='+encodeURIComponent(t)+'&community='+encodeURIComponent(c)+'&ifindex='+encodeURIComponent(i))
     .then(r => r.json())
     .then(data => {
       if(data.ok) {
         showOutput(`‚úÖ Port ${i} successfully set to DOWN (LED Pattern: 1‚Üí2‚Üí3‚Üí4‚Üí5)\n`);
         showNotification('Port successfully set to down', 'success');
         // Refresh interface list if we're in discovery mode
         if(target) {
           setTimeout(() => discoverInterfaces(), 1000);
         }
       } else {
         showOutput(`‚ùå Port down failed: ${data.error || 'Unknown error'}\n`);
         showNotification('Port down failed: ' + (data.error || 'Unknown error'), 'error');
       }
     })
     .catch(err => {
       console.error('SNMP Port Down error:', err);
       showOutput(`‚ùå Port down error: ${err.message}\n`);
       showNotification('Port down failed', 'error');
     });
 }

 function snmpPortUp(target = null, community = null, ifindex = null) {
   const t = target || document.getElementById('snmp_target').value.trim();
   const c = community || document.getElementById('snmp_rw').value.trim();
   const i = ifindex || document.getElementById('manual_ifindex').value.trim();
   
   if(!t || !i) {
     alert('Please enter both target IP and interface index');
     return;
   }
   
   showOutput(`üü¢ Setting port ${i} UP on ${t}...\n`);
   
   fetch('/snmp/portup?target='+encodeURIComponent(t)+'&community='+encodeURIComponent(c)+'&ifindex='+encodeURIComponent(i))
     .then(r => r.json())
     .then(data => {
       if(data.ok) {
         showOutput(`‚úÖ Port ${i} successfully set to UP (LED Pattern: 5‚Üí4‚Üí3‚Üí2‚Üí1)\n`);
         showNotification('Port successfully set to up', 'success');
         // Refresh interface list if we're in discovery mode
         if(target) {
           setTimeout(() => discoverInterfaces(), 1000);
         }
       } else {
         showOutput(`‚ùå Port up failed: ${data.error || 'Unknown error'}\n`);
         showNotification('Port up failed: ' + (data.error || 'Unknown error'), 'error');
       }
     })
     .catch(err => {
       console.error('SNMP Port Up error:', err);
       showOutput(`‚ùå Port up error: ${err.message}\n`);
       showNotification('Port up failed', 'error');
     });
 }

 function snmpWalk(){
   const t = document.getElementById('snmp_target').value.trim();
   const c = document.getElementById('snmp_ro').value.trim();
   if(!t){ 
     alert('Please enter a target IP address'); 
     return; 
   }
   
   showOutput(`üìã Running SNMP Walk on ${t}...\n`);
   
   fetch('/snmp/walk?target='+encodeURIComponent(t)+'&community='+encodeURIComponent(c))
     .then(r=>r.json())
     .then(data => {
       if (data.ok) {
         showOutput(`‚úÖ SNMP Walk completed successfully!\nOutput:\n${data.output}\n`);
         showNotification('SNMP Walk completed successfully', 'success');
       } else {
         showOutput(`‚ùå SNMP Walk failed: ${data.error || 'Unknown error'}\n`);
         showNotification('SNMP Walk failed: ' + (data.error || 'Unknown error'), 'error');
       }
     })
     .catch(err => {
       console.error('SNMP Walk error:', err);
       showOutput(`‚ùå SNMP Walk error: ${err.message}\n`);
       showNotification('SNMP Walk failed', 'error');
     });
 }

 function showOutput(message) {
   const container = document.getElementById('output_container');
   const area = document.getElementById('output_area');
   
   // Show container if hidden
   container.style.display = 'block';
   
   // Add timestamp
   const timestamp = new Date().toLocaleTimeString();
   const formattedMessage = `[${timestamp}] ${message}`;
   
   // Append to existing content
   area.textContent += formattedMessage;
   
   // Auto-scroll to bottom
   area.scrollTop = area.scrollHeight;
 }
 
 function clearOutput() {
   const area = document.getElementById('output_area');
   area.textContent = '';
   document.getElementById('output_container').style.display = 'none';
 }
 
 function showNotification(message, type) {
   // Simple notification system
   const notification = document.createElement('div');
   notification.style.cssText = `
     position: fixed;
     top: 20px;
     right: 20px;
     padding: 12px 20px;
     border-radius: 8px;
     color: white;
     font-weight: 500;
     z-index: 1000;
     background: ${type === 'success' ? '#10b981' : '#ef4444'};
     box-shadow: 0 4px 12px rgba(0,0,0,0.15);
     transform: translateX(100%);
     transition: transform 0.3s ease;
   `;
   notification.textContent = message;
   document.body.appendChild(notification);
   
   setTimeout(() => notification.style.transform = 'translateX(0)', 100);
   setTimeout(() => {
     notification.style.transform = 'translateX(100%)';
     setTimeout(() => document.body.removeChild(notification), 300);
   }, 3000);
 }

// SSE to update LED dots with improved error handling
let evt;
function connectSSE() {
  try {
    evt = new EventSource('/events');
    evt.onmessage = (e) => {
      try {
        const data = JSON.parse(e.data);
        const pins = (data && data.pins) || {};
        setDot('d17', pins["17"]); 
        setDot('d27', pins["27"]);
        setDot('d22', pins["22"]); 
        setDot('d10', pins["10"]);
        setDot('d09', pins["9"]);  
        setDot('d5', pins["5"]);
        setDot('d6', pins["6"]);
        
        // Update status indicator
        document.getElementById('status').innerHTML = '<span>‚óè</span> Online';
        document.getElementById('status').classList.remove('offline');
      } catch(err) {
        console.error('SSE data parse error:', err);
      }
    };
    
    evt.onerror = () => {
      document.getElementById('status').innerHTML = '<span>‚óè</span> Offline';
      document.getElementById('status').classList.add('offline');
      setTimeout(connectSSE, 5000); // Reconnect after 5 seconds
    };
  } catch(err) {
    console.error('SSE connection error:', err);
    setTimeout(connectSSE, 5000);
  }
}

function setDot(id, level){ 
  const el = document.getElementById(id); 
  if(!el) return; 
  el.classList.toggle('on', level === 1); 
}

// Initialize SSE connection
connectSSE();
</script>
</body>
</html>
