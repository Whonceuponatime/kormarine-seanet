<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Network Demo ‚Äî LED Visualization</title>
<style>
  :root { 
    --bg: #f8fafc; 
    --card: #ffffff; 
    --muted: #64748b; 
    --accent: #0ea5e9; 
    --danger: #ef4444;
    --success: #10b981;
    --warning: #f59e0b;
    --border: #e2e8f0;
    --text: #1e293b;
    --text-light: #64748b;
  }
  
  html,body { height:100%; margin:0; }
  body { 
    background: var(--bg); 
    color: var(--text); 
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif; 
    display:flex; 
    flex-direction:column;
    line-height: 1.6;
  }
  
  header { 
    padding: 16px 20px; 
    border-bottom: 1px solid var(--border); 
    background: var(--card); 
    display:flex; 
    align-items:center; 
    gap:16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  header h1 { 
    margin:0; 
    font-size: 20px;
    font-weight: 600;
    color: var(--text);
  }
  
  .tabs { display:flex; gap:8px; margin-left:auto; }
  .tab { 
    background: var(--bg); 
    border: 1px solid var(--border); 
    color: var(--text-light); 
    padding: 10px 16px; 
    border-radius: 12px; 
    cursor:pointer; 
    font-weight: 500;
    transition: all 0.2s ease;
  }
  .tab:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
  }
  .tab.active { 
    background: var(--accent); 
    border-color: var(--accent); 
    color: white;
    box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
  }

  main { flex:1; min-height:0; display:flex; }
  .card { 
    flex:1; 
    min-height:0; 
    display:flex; 
    flex-direction:column; 
    gap: 16px; 
    padding: 20px; 
  }
  
  .panel { 
    background: var(--card); 
    border: 1px solid var(--border); 
    border-radius: 16px; 
    padding: 20px; 
    display: flex; 
    flex-direction: column; 
    min-height: 0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  .stage-wrap { flex:1; min-height:0; display:flex; }
  .stage { 
    flex:1; 
    width:100%; 
    height:100%; 
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); 
    border: 1px solid var(--border); 
    border-radius: 16px;
    padding: 20px;
  }

  
  
  .badge { 
    display:inline-flex; 
    align-items:center; 
    gap: 8px; 
    padding: 8px 12px; 
    border-radius: 20px; 
    font-size: 13px; 
    border: 1px solid var(--border); 
    background: var(--card);
    font-weight: 500;
  }
  
  .req { 
    color: #dc2626; 
    border-color: #fecaca; 
    background: #fef2f2;
  }
  
  .res { 
    color: var(--success); 
    border-color: #bbf7d0; 
    background: #f0fdf4;
  }
  
  .ping { 
    color: #ea580c; 
    border-color: #fed7aa; 
    background: #fff7ed;
  }

  .node { 
    fill: var(--card); 
    stroke: var(--accent); 
    stroke-width: 3;
    filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
  }
  
  .node-label { 
    fill: var(--text); 
    font-weight: 600; 
    font-size: 16px;
  }
  
  .controls { 
    display:flex; 
    gap: 12px; 
    flex-wrap:wrap; 
    align-items:center;
    margin-top: 16px;
  }
  
  .dotbar { 
    display:flex; 
    gap: 10px; 
    flex-wrap:wrap;
    padding: 12px;
    background: var(--bg);
    border-radius: 12px;
    border: 1px solid var(--border);
  }
  
  .dot { 
    width: 20px; 
    height: 20px; 
    border-radius: 50%; 
    background: var(--card); 
    border: 2px solid var(--border); 
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    position: relative;
  }
  
  .dot::after {
    content: attr(title);
    position: absolute;
    bottom: -25px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: var(--text-light);
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.2s ease;
  }
  
  .dot:hover::after {
    opacity: 1;
  }
  
  .dot.on { 
    background: var(--success); 
    border-color: var(--success);
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.4), inset 0 2px 4px rgba(0,0,0,0.1);
    transform: scale(1.1);
  }
  
  .dot.r.on { 
    background: var(--danger); 
    border-color: var(--danger);
    box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
  }
  
  button { 
    background: var(--card); 
    border: 1px solid var(--border); 
    color: var(--text); 
    padding: 12px 18px; 
    border-radius: 12px; 
    cursor: pointer; 
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  button:hover { 
    border-color: var(--accent);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
  }
  
  button.accent { 
    background: var(--accent); 
    border-color: var(--accent); 
    color: white;
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
  }
  
  button.accent:hover {
    background: #0284c7;
    box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4);
  }
  
  button.danger { 
    background: var(--danger); 
    border-color: var(--danger); 
    color: white;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }
  
  button.danger:hover {
    background: #dc2626;
    box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
  }
  
  button.success {
    background: var(--success);
    border-color: var(--success);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }
  
  button.success:hover {
    background: #059669;
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
  }
  
  input, select { 
    background: var(--card); 
    color: var(--text); 
    border: 1px solid var(--border); 
    border-radius: 12px; 
    padding: 12px 16px;
    font-size: 14px;
    transition: all 0.2s ease;
  }
  
  input:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
  }
  
  .status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    background: var(--success);
    color: white;
    margin-left: auto;
  }
  
  .status-indicator.offline {
    background: var(--danger);
  }
  
  .interface-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--bg);
    margin-top: 12px;
  }
  
  .interface-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    transition: background 0.2s ease;
  }
  
  .interface-item:hover {
    background: var(--card);
  }
  
  .interface-item:last-child {
    border-bottom: none;
  }
  
  .interface-info {
    flex: 1;
  }
  
  .interface-name {
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
  }
  
  .interface-status {
    font-size: 12px;
    color: var(--text-light);
  }
  
  .status-up {
    color: var(--success);
  }
  
  .status-down {
    color: var(--danger);
  }
  
  .interface-actions {
    display: flex;
    gap: 8px;
  }
  
  .loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--border);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1s ease-in-out infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
     .section-title {
     font-size: 16px;
     font-weight: 600;
     color: var(--text);
     margin-bottom: 12px;
     display: flex;
     align-items: center;
     gap: 8px;
   }
   
   /* Modal Styles */
   .modal {
     display: none;
     position: fixed;
     z-index: 1000;
     left: 0;
     top: 0;
     width: 100%;
     height: 100%;
     background-color: rgba(0, 0, 0, 0.5);
     backdrop-filter: blur(4px);
   }
   
   .modal-content {
     background-color: var(--card);
     margin: 5% auto;
     padding: 0;
     border: 1px solid var(--border);
     border-radius: 16px;
     width: 80%;
     max-width: 800px;
     max-height: 80vh;
     box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
     animation: modalSlideIn 0.3s ease-out;
   }
   
   @keyframes modalSlideIn {
     from {
       opacity: 0;
       transform: translateY(-20px);
     }
     to {
       opacity: 1;
       transform: translateY(0);
     }
   }
   
   .modal-header {
     padding: 20px 24px 16px;
     border-bottom: 1px solid var(--border);
     display: flex;
     justify-content: space-between;
     align-items: center;
   }
   
   .modal-title {
     font-size: 18px;
     font-weight: 600;
     color: var(--text);
     margin: 0;
   }
   
   .modal-close {
     background: none;
     border: none;
     font-size: 24px;
     cursor: pointer;
     color: var(--text-light);
     padding: 4px;
     border-radius: 8px;
     transition: all 0.2s ease;
   }
   
   .modal-close:hover {
     background: var(--bg);
     color: var(--text);
   }
   
   .modal-body {
     padding: 20px 24px;
     max-height: 60vh;
     overflow-y: auto;
   }
   
   .modal-output {
     background: var(--bg);
     border: 1px solid var(--border);
     border-radius: 12px;
     padding: 16px;
     font-family: 'Courier New', monospace;
     font-size: 13px;
     line-height: 1.4;
     white-space: pre-wrap;
     color: var(--text);
     max-height: 400px;
     overflow-y: auto;
   }
</style>
</head>
<body>
  <header>
    <h1>üîß SNMP Network Management ‚Äî LED Visualization</h1>
    <div class="status-indicator" id="status">
      <span>‚óè</span> Online
    </div>
  <div class="tabs">
    <div class="tab active" data-tab="demo" onclick="showTab('demo', this)">Demo</div>
    <div class="tab" data-tab="settings" onclick="showTab('settings', this)">Settings</div>
  </div>
</header>

<main>
  <div class="card">
    <!-- VISUAL PANEL -->
    <div id="demo" class="panel section active">
             
      <div class="stage-wrap">
        <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 1px solid var(--border); border-radius: 16px; padding: 20px; min-height: 400px; position: relative; overflow: hidden;">
          <div style="position: absolute; top: 10px; left: 20px; z-index: 10;">
            <h3 style="color: var(--text); margin: 0 0 10px 0; font-size: 18px;">üåê Interactive Network Topology</h3>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="accent" style="padding: 6px 12px; font-size: 11px;" onclick="simulateAttack()">üöÄ Attack</button>
              <button style="padding: 6px 12px; font-size: 11px;" onclick="showNetworkInfo()">üìä Info</button>
              <button style="padding: 6px 12px; font-size: 11px;" onclick="selectRouterTarget()">üéØ Select Router</button>
              <button style="padding: 6px 12px; font-size: 11px;" onclick="startPacketAnimation()">üì¶ Animate</button>
            </div>
          </div>
          
          <!-- Network Diagram Container -->
          <div id="network-diagram" style="width: 100%; height: 350px; margin-top: 60px; overflow: hidden; border-radius: 12px; background: white; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); position: relative;">
            <!-- Embedded SVG from Draw.io -->
            <div style="width: 100%; height: 100%; transform: scale(0.25); transform-origin: top left; position: absolute; top: 0; left: 0;">
              <!-- SVG will be embedded here via JavaScript -->
            </div>
          </div>
          
          <!-- Clickable Hotspots Overlay -->
          <div id="diagram-hotspots" style="position: absolute; top: 60px; left: 20px; right: 20px; bottom: 20px; pointer-events: none;">
            <!-- Hotspots will be added by JavaScript -->
          </div>
        </div>
      </div>

      

       <!-- SNMP Section -->
       <div class="section-title" style="margin-top: 24px; border-top: 1px solid var(--border); padding-top: 16px;">
         üîß SNMP Network Management
       </div>
       
       <div class="controls">
        <input id="snmp_target" placeholder="SNMP Target IP" style="min-width: 180px;">
        <input id="snmp_ro" placeholder="RO Community" value="community" style="width: 120px;">
        <input id="snmp_rw" placeholder="RW Community" value="private" style="width: 120px;">
        <button class="accent" onclick="discoverInterfaces()">üîç Discover Interfaces</button>
        <button onclick="snmpWalk()">üìã SNMP Walk</button>
      </div>

       <div class="controls" style="margin-top: 12px;">
         <input id="manual_ifindex" placeholder="Interface Index (e.g. 7)" style="width: 160px;">
         <button class="danger" onclick="snmpPortDown()">üî¥ Port Down</button>
         <button class="success" onclick="snmpPortUp()">üü¢ Port Up</button>
       </div>



       <!-- Interface List -->
       <div id="interface_container" style="margin-top: 16px; display: none;">
         <div class="section-title">üåê Discovered Interfaces</div>
         <div class="interface-list" id="interface_list">
           <!-- Interfaces will be populated here -->
         </div>
       </div>
     </div>


    <!-- SETTINGS PANEL -->
    <div id="settings" class="panel section" style="display:none">
      <div class="section-title">
        ‚öôÔ∏è LED Control Panel
      </div>
      <div class="controls">
        <button onclick="fetch('/on17')">ON 17</button>
        <button onclick="fetch('/on27')">ON 27</button>
        <button onclick="fetch('/on22')">ON 22</button>
        <button onclick="fetch('/on10')">ON 10</button>
        <button onclick="fetch('/on9')">ON 9</button>
        <button onclick="fetch('/on5')">ON 5</button>
        <button onclick="fetch('/on6')">ON 6</button>
        <button onclick="fetch('/off')">All OFF</button>
      </div>
      <div class="controls">
        <label style="font-weight: 500; color: var(--text);">Wave Speed:</label>
        <select id="hz">
          <option value="1">1 Hz</option>
          <option value="2">2 Hz</option>
          <option value="3">3 Hz</option>
          <option value="5">5 Hz</option>
        </select>
        <button class="accent" onclick="startWave()">Start Wave</button>
        <button onclick="stopWave()">Stop</button>
      </div>
      <div style="opacity: 0.7; font-size: 13px; margin-top: 12px; color: var(--text-light);">
        üí° Settings tab is for LED testing. Demo tab focuses on network operations.
      </div>
    </div>
     </div>
 </main>

 <!-- Output Modal -->
 <div id="outputModal" class="modal">
   <div class="modal-content">
     <div class="modal-header">
       <h3 class="modal-title">üìä Command Output</h3>
       <button class="modal-close" onclick="closeModal()">&times;</button>
     </div>
     <div class="modal-body">
       <div id="modalOutput" class="modal-output"></div>
     </div>
   </div>
 </div>

 <script>
// Colors: updated for light mode
function setPacketColors(reqColor, resColor){
  document.getElementById('pkt_req').setAttribute('fill', reqColor);
  document.getElementById('pkt_res').setAttribute('fill', resColor);
}

function showTab(id, btn){
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='flex';
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
}

function startWave(){ 
  const hz=document.getElementById('hz').value; 
  fetch('/start?hz='+hz); 
}

function stopWave(){ 
  fetch('/stop'); 
}





// SNMP Functions
 function discoverInterfaces() {
   const target = document.getElementById('snmp_target').value.trim();
   const community = document.getElementById('snmp_ro').value.trim();
   
   if(!target) {
     alert('Please enter a target IP address');
     return;
   }
   
   const container = document.getElementById('interface_container');
   const list = document.getElementById('interface_list');
   
   // Show loading and output
   container.style.display = 'block';
   showOutput(`üîç Discovering interfaces on ${target}...\n`);
   list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-light);"><div class="loading"></div> Discovering interfaces...</div>';
   
   fetch('/snmp/interfaces?target='+encodeURIComponent(target)+'&community='+encodeURIComponent(community))
     .then(r => r.json())
     .then(data => {
       if(data.ok) {
         showOutput(`‚úÖ Interface discovery successful!\nFound ${Object.keys(data.interfaces.names || {}).length} interfaces\n`);
         displayInterfaces(data.interfaces, target, community);
       } else {
         showOutput(`‚ùå Interface discovery failed: ${data.error || 'Unknown error'}\n`);
         list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">‚ùå Failed to discover interfaces: ' + (data.error || 'Unknown error') + '</div>';
       }
     })
     .catch(err => {
       console.error('Interface discovery failed:', err);
       showOutput(`‚ùå Interface discovery error: ${err.message}\n`);
       list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">‚ùå Interface discovery failed</div>';
     });
 }

function displayInterfaces(interfaces, target, community) {
  const list = document.getElementById('interface_list');
  
  try {
    // Parse SNMP output to extract interface information
    const names = parseSnmpOutput(interfaces.names);
    const adminStatus = parseSnmpOutput(interfaces.admin_status);
    const operStatus = parseSnmpOutput(interfaces.oper_status);
    
    let html = '';
    
    for(let i = 1; i <= Math.max(names.length, adminStatus.length, operStatus.length); i++) {
      const name = names[i] || `Interface ${i}`;
      const admin = adminStatus[i] || 'unknown';
      const oper = operStatus[i] || 'unknown';
      
      const adminText = admin === '1' ? 'Up' : admin === '2' ? 'Down' : 'Unknown';
      const operText = oper === '1' ? 'Up' : oper === '2' ? 'Down' : 'Unknown';
      
      const adminClass = admin === '1' ? 'status-up' : admin === '2' ? 'status-down' : '';
      const operClass = oper === '1' ? 'status-up' : oper === '2' ? 'status-down' : '';
      
      html += `
        <div class="interface-item">
          <div class="interface-info">
            <div class="interface-name">${name}</div>
            <div class="interface-status">
              Admin: <span class="${adminClass}">${adminText}</span> | 
              Oper: <span class="${operClass}">${operText}</span>
            </div>
          </div>
                     <div class="interface-actions">
             <button class="danger" style="padding: 6px 12px; font-size: 12px;" onclick="snmpPortDown('${target}', '${community}', '${i}')">Down</button>
             <button class="success" style="padding: 6px 12px; font-size: 12px;" onclick="snmpPortUp('${target}', '${community}', '${i}')">Up</button>
           </div>
        </div>
      `;
    }
    
    if(html === '') {
      html = '<div style="padding: 20px; text-align: center; color: var(--text-light);">No interfaces found</div>';
    }
    
    list.innerHTML = html;
  } catch(err) {
    console.error('Error parsing interfaces:', err);
    list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">‚ùå Error parsing interface data</div>';
  }
}

function parseSnmpOutput(output) {
  const result = {};
  const lines = output.split('\n');
  
  for(const line of lines) {
    const match = line.match(/\.(\d+)\s*=\s*(.+)$/);
    if(match) {
      const index = match[1];
      let value = match[2].trim();
      
      // Remove quotes if present
      if(value.startsWith('"') && value.endsWith('"')) {
        value = value.slice(1, -1);
      }
      
      result[index] = value;
    }
  }
  
  return result;
}

 function snmpPortDown(target = null, community = null, ifindex = null) {
   const t = target || document.getElementById('snmp_target').value.trim();
   const c = community || document.getElementById('snmp_rw').value.trim();
   const i = ifindex || document.getElementById('manual_ifindex').value.trim();
   
   if(!t || !i) {
     alert('Please enter both target IP and interface index');
     return;
   }
   
   showOutput(`üî¥ Setting port ${i} DOWN on ${t}...\n`);
   
   fetch('/snmp/portdown?target='+encodeURIComponent(t)+'&community='+encodeURIComponent(c)+'&ifindex='+encodeURIComponent(i))
     .then(r => r.json())
     .then(data => {
       if(data.ok) {
         showOutput(`‚úÖ Port ${i} successfully set to DOWN\n`);
         showNotification('Port successfully set to down', 'success');
         // Refresh interface list if we're in discovery mode
         if(target) {
           setTimeout(() => discoverInterfaces(), 1000);
         }
       } else {
         showOutput(`‚ùå Port down failed: ${data.error || 'Unknown error'}\n`);
         showNotification('Port down failed: ' + (data.error || 'Unknown error'), 'error');
       }
     })
     .catch(err => {
       console.error('SNMP Port Down error:', err);
       showOutput(`‚ùå Port down error: ${err.message}\n`);
       showNotification('Port down failed', 'error');
     });
 }

 function snmpPortUp(target = null, community = null, ifindex = null) {
   const t = target || document.getElementById('snmp_target').value.trim();
   const c = community || document.getElementById('snmp_rw').value.trim();
   const i = ifindex || document.getElementById('manual_ifindex').value.trim();
   
   if(!t || !i) {
     alert('Please enter both target IP and interface index');
     return;
   }
   
   showOutput(`üü¢ Setting port ${i} UP on ${t}...\n`);
   
   fetch('/snmp/portup?target='+encodeURIComponent(t)+'&community='+encodeURIComponent(c)+'&ifindex='+encodeURIComponent(i))
     .then(r => r.json())
     .then(data => {
       if(data.ok) {
         showOutput(`‚úÖ Port ${i} successfully set to UP\n`);
         showNotification('Port successfully set to up', 'success');
         // Refresh interface list if we're in discovery mode
         if(target) {
           setTimeout(() => discoverInterfaces(), 1000);
         }
       } else {
         showOutput(`‚ùå Port up failed: ${data.error || 'Unknown error'}\n`);
         showNotification('Port up failed: ' + (data.error || 'Unknown error'), 'error');
       }
     })
     .catch(err => {
       console.error('SNMP Port Up error:', err);
       showOutput(`‚ùå Port up error: ${err.message}\n`);
       showNotification('Port up failed', 'error');
     });
 }

 function snmpWalk(){
   const t = document.getElementById('snmp_target').value.trim();
   const c = document.getElementById('snmp_ro').value.trim();
   if(!t){ 
     alert('Please enter a target IP address'); 
     return; 
   }
   
   showOutput(`üìã Running SNMP Walk on ${t}...\n`);
   
   fetch('/snmp/walk?target='+encodeURIComponent(t)+'&community='+encodeURIComponent(c))
     .then(r=>r.json())
     .then(data => {
       if (data.ok) {
         showOutput(`‚úÖ SNMP Walk completed successfully!\nOutput:\n${data.output}\n`);
         showNotification('SNMP Walk completed successfully', 'success');
       } else {
         showOutput(`‚ùå SNMP Walk failed: ${data.error || 'Unknown error'}\n`);
         showNotification('SNMP Walk failed: ' + (data.error || 'Unknown error'), 'error');
       }
     })
     .catch(err => {
       console.error('SNMP Walk error:', err);
       showOutput(`‚ùå SNMP Walk error: ${err.message}\n`);
       showNotification('SNMP Walk failed', 'error');
     });
 }

 function showOutput(message) {
   const modal = document.getElementById('outputModal');
   const modalOutput = document.getElementById('modalOutput');
   
   // Add timestamp
   const timestamp = new Date().toLocaleTimeString();
   const formattedMessage = `[${timestamp}] ${message}`;
   
   // Append to existing content
   modalOutput.textContent += formattedMessage;
   
   // Auto-scroll to bottom
   modalOutput.scrollTop = modalOutput.scrollHeight;
   
   // Show modal
   modal.style.display = 'block';
 }
 
 function closeModal() {
   document.getElementById('outputModal').style.display = 'none';
 }
 
 function clearOutput() {
   document.getElementById('modalOutput').textContent = '';
   closeModal();
 }
 
 function showNotification(message, type) {
   // Simple notification system
   const notification = document.createElement('div');
   notification.style.cssText = `
     position: fixed;
     top: 20px;
     right: 20px;
     padding: 12px 20px;
     border-radius: 8px;
     color: white;
     font-weight: 500;
     z-index: 1000;
     background: ${type === 'success' ? '#10b981' : '#ef4444'};
     box-shadow: 0 4px 12px rgba(0,0,0,0.15);
     transform: translateX(100%);
     transition: transform 0.3s ease;
   `;
   notification.textContent = message;
   document.body.appendChild(notification);
   
   setTimeout(() => notification.style.transform = 'translateX(0)', 100);
   setTimeout(() => {
     notification.style.transform = 'translateX(100%)';
     setTimeout(() => document.body.removeChild(notification), 300);
   }, 3000);
 }

// SSE to update LED dots with improved error handling
let evt;
function connectSSE() {
  try {
    evt = new EventSource('/events');
    evt.onmessage = (e) => {
      try {
        const data = JSON.parse(e.data);
        const pins = (data && data.pins) || {};
        setDot('d17', pins["17"]); 
        setDot('d27', pins["27"]);
        setDot('d22', pins["22"]); 
        setDot('d10', pins["10"]);
        setDot('d09', pins["9"]);  
        setDot('d5', pins["5"]);
        setDot('d6', pins["6"]);
        
        // Update status indicator
        document.getElementById('status').innerHTML = '<span>‚óè</span> Online';
        document.getElementById('status').classList.remove('offline');
      } catch(err) {
        console.error('SSE data parse error:', err);
      }
    };
    
    evt.onerror = () => {
      document.getElementById('status').innerHTML = '<span>‚óè</span> Offline';
      document.getElementById('status').classList.add('offline');
      setTimeout(connectSSE, 5000); // Reconnect after 5 seconds
    };
  } catch(err) {
    console.error('SSE connection error:', err);
    setTimeout(connectSSE, 5000);
  }
}

function setDot(id, level){ 
  const el = document.getElementById(id); 
  if(!el) return; 
  el.classList.toggle('on', level === 1); 
}

// Initialize SSE connection
connectSSE();

// Interactive Network Diagram Functions
function initializeDiagram() {
  createPortHotspots();
  setupHackerInteraction();
  setupRouterInteraction();
}

function createPortHotspots() {
  const routerGroup = document.getElementById('router-group');
  if (!routerGroup) return;
  
  const baseX = 250, baseY = 100;
  const portPositions = [
    // Left column ports (8, 6, 4, 2)
    { port: 8, x: baseX + 20, y: baseY + 200 },
    { port: 6, x: baseX + 20, y: baseY + 220 },
    { port: 4, x: baseX + 20, y: baseY + 240 },
    { port: 2, x: baseX + 20, y: baseY + 260 },
    // Right column ports (7, 5, 3, 1)
    { port: 7, x: baseX + 65, y: baseY + 200 },
    { port: 5, x: baseX + 65, y: baseY + 220 },
    { port: 3, x: baseX + 65, y: baseY + 240 },
    { port: 1, x: baseX + 65, y: baseY + 260 }
  ];
  
  const routerIP = routerGroup.dataset.ip || '192.168.10.1';
  
  portPositions.forEach(pos => {
    const hotspot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    hotspot.setAttribute('cx', pos.x + 17);
    hotspot.setAttribute('cy', pos.y + 6);
    hotspot.setAttribute('r', '8');
    hotspot.setAttribute('class', 'port-hotspot');
    hotspot.setAttribute('data-port', pos.port);
    hotspot.setAttribute('data-ip', routerIP);
    hotspot.style.cssText = 'fill: transparent; stroke: transparent; cursor: pointer; transition: all 0.2s ease;';
    
    hotspot.addEventListener('mouseenter', () => {
      hotspot.style.stroke = '#0ea5e9';
      hotspot.style.strokeWidth = '2';
      hotspot.style.fill = 'rgba(14, 165, 233, 0.1)';
    });
    
    hotspot.addEventListener('mouseleave', () => {
      hotspot.style.stroke = 'transparent';
      hotspot.style.fill = 'transparent';
    });
    
    hotspot.addEventListener('click', () => {
      selectPort(routerIP, pos.port);
    });
    
    routerGroup.appendChild(hotspot);
  });
}

function setupHackerInteraction() {
  const hackerClick = document.getElementById('hacker-click');
  if (!hackerClick) return;
  
  hackerClick.addEventListener('click', () => {
    simulateAttack();
  });
  
  // Add hover effect to hacker group
  const hackerGroup = document.getElementById('hacker-group');
  if (hackerGroup) {
    hackerGroup.style.cursor = 'pointer';
    hackerGroup.addEventListener('mouseenter', () => {
      hackerGroup.style.filter = 'drop-shadow(0 0 10px rgba(239, 68, 68, 0.5))';
    });
    hackerGroup.addEventListener('mouseleave', () => {
      hackerGroup.style.filter = 'none';
    });
  }
}

function setupRouterInteraction() {
  const routerGroup = document.getElementById('router-group');
  if (!routerGroup) return;
  
  // Add hover effect to router
  routerGroup.addEventListener('mouseenter', () => {
    routerGroup.style.filter = 'drop-shadow(0 0 15px rgba(16, 185, 129, 0.3))';
  });
  routerGroup.addEventListener('mouseleave', () => {
    routerGroup.style.filter = 'none';
  });
}

function selectPort(ip, port) {
  // Update form fields
  document.getElementById('snmp_target').value = ip;
  document.getElementById('manual_ifindex').value = port;
  
  // Show notification
  showNotification(`Selected ${ip} port ${port}`, 'success');
  
  // Visual feedback
  const hotspot = document.querySelector(`[data-port="${port}"]`);
  if (hotspot) {
    hotspot.style.stroke = '#10b981';
    hotspot.style.strokeWidth = '3';
    hotspot.style.fill = 'rgba(16, 185, 129, 0.2)';
    setTimeout(() => {
      hotspot.style.stroke = 'transparent';
      hotspot.style.fill = 'transparent';
    }, 1000);
  }
  
  // Switch to demo tab to show the selected values
  showTab('demo', document.querySelector('[data-tab="demo"]'));
}

function simulateAttack() {
  showNotification('üöÄ Simulating network attack...', 'success');
  
  // Visual attack animation
  const hackerGroup = document.getElementById('hacker-group');
  const routerGroup = document.getElementById('router-group');
  
  if (hackerGroup && routerGroup) {
    // Flash hacker
    hackerGroup.style.filter = 'drop-shadow(0 0 20px rgba(239, 68, 68, 0.8))';
    
    // Create attack line
    const attackLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    attackLine.setAttribute('x1', '200');
    attackLine.setAttribute('y1', '260');
    attackLine.setAttribute('x2', '250');
    attackLine.setAttribute('y2', '300');
    attackLine.setAttribute('stroke', '#ef4444');
    attackLine.setAttribute('stroke-width', '4');
    attackLine.setAttribute('stroke-dasharray', '10,5');
    attackLine.style.opacity = '0';
    attackLine.style.transition = 'opacity 0.5s ease';
    
    const svg = document.querySelector('#diagram svg');
    svg.appendChild(attackLine);
    
    // Animate attack
    setTimeout(() => {
      attackLine.style.opacity = '1';
      routerGroup.style.filter = 'drop-shadow(0 0 20px rgba(239, 68, 68, 0.8))';
    }, 100);
    
    setTimeout(() => {
      attackLine.style.opacity = '0';
      hackerGroup.style.filter = 'none';
      routerGroup.style.filter = 'none';
      setTimeout(() => svg.removeChild(attackLine), 500);
    }, 2000);
  }
  
  // Show output
  showOutput('üöÄ Network attack simulation initiated\nTarget: 192.168.10.1\nMethod: SNMP exploitation\nStatus: Vulnerable ports detected\n');
}

function resetDiagram() {
  // Reset all visual effects
  const elements = document.querySelectorAll('#diagram *');
  elements.forEach(el => {
    el.style.filter = 'none';
    el.style.stroke = '';
    el.style.fill = '';
  });
  
  // Clear form fields
  document.getElementById('snmp_target').value = '';
  document.getElementById('manual_ifindex').value = '';
  
  showNotification('üîÑ Diagram reset', 'success');
}

function highlightPorts() {
  const hotspots = document.querySelectorAll('.port-hotspot');
  hotspots.forEach((hotspot, index) => {
    setTimeout(() => {
      hotspot.style.stroke = '#f59e0b';
      hotspot.style.strokeWidth = '3';
      hotspot.style.fill = 'rgba(245, 158, 11, 0.2)';
      
      setTimeout(() => {
        hotspot.style.stroke = 'transparent';
        hotspot.style.fill = 'transparent';
      }, 500);
    }, index * 100);
  });
  
  showNotification('üí° All ports highlighted', 'success');
}

// Network Diagram Functions
function simulateAttack() {
  showNotification('üöÄ Simulating network attack...', 'success');
  showOutput('üöÄ Network attack simulation initiated\nTarget: 192.168.10.1\nMethod: SNMP exploitation\nStatus: Vulnerable ports detected\n');
}

function selectRouterTarget() {
  document.getElementById('snmp_target').value = '192.168.10.1';
  showNotification('üéØ Router target selected: 192.168.10.1', 'success');
  showTab('demo', document.querySelector('[data-tab="demo"]'));
}

function showNetworkInfo() {
  const info = `üìä Network Topology Information:

üîß Central Router: MOXA EDR-G9010-VPN-2MGSFP
   IP Address: 192.168.10.1
   Ports: 8 x RJ45 Ethernet
   Management: MG1/MG2 ports
   
üñ•Ô∏è VLAN 10 Devices: 4 connected devices
   All devices online and operational
   
üîí Security Status: ‚ö†Ô∏è VULNERABLE
   SNMP community strings may be default
   Ports can be controlled remotely
   
üí° Use the Demo tab to interact with the network`;

  showOutput(info);
}

function initializeDiagram() {
  // Load the network diagram SVG
  const diagramContainer = document.querySelector('#network-diagram > div');
  if (diagramContainer) {
    // Use fetch to load the SVG file
    fetch('rpi background.drawio.svg')
      .then(response => response.text())
      .then(svgContent => {
        diagramContainer.innerHTML = svgContent;
        setupInteractiveHotspots();
      })
      .catch(error => {
        console.log('Could not load diagram, using fallback');
        // Fallback to a simplified diagram
        diagramContainer.innerHTML = `
          <div style="display: flex; justify-content: center; align-items: center; height: 100%; font-size: 48px; background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);">
            <div style="text-align: center; transform: scale(4);">
              <div style="margin: 20px;">üë§üíª</div>
              <div style="margin: 20px;">‚¨áÔ∏è</div>
              <div style="margin: 20px; padding: 10px; border: 2px solid #007acc; border-radius: 8px; background: white;">üîßüì°</div>
              <div style="margin: 20px;">‚¨áÔ∏è</div>
              <div style="margin: 20px;">üñ•Ô∏èüñ•Ô∏èüñ•Ô∏èüñ•Ô∏è</div>
            </div>
          </div>
        `;
        setupInteractiveHotspots();
      });
  }
}

function setupInteractiveHotspots() {
  // Add clickable overlay hotspots for interaction
  const hotspotsContainer = document.getElementById('diagram-hotspots');
  if (!hotspotsContainer) return;
  
  // Clear existing hotspots
  hotspotsContainer.innerHTML = '';
  
  // Add router hotspot (center of diagram)
  const routerHotspot = document.createElement('div');
  routerHotspot.style.cssText = `
    position: absolute;
    top: 40%;
    left: 45%;
    width: 10%;
    height: 20%;
    background: rgba(0, 122, 204, 0.2);
    border: 2px dashed #007acc;
    border-radius: 8px;
    cursor: pointer;
    pointer-events: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  `;
  routerHotspot.innerHTML = '<span style="font-size: 12px; color: #007acc; font-weight: bold;">Router</span>';
  routerHotspot.onclick = selectRouterTarget;
  routerHotspot.onmouseover = () => {
    routerHotspot.style.background = 'rgba(0, 122, 204, 0.3)';
  };
  routerHotspot.onmouseout = () => {
    routerHotspot.style.background = 'rgba(0, 122, 204, 0.2)';
  };
  
  hotspotsContainer.appendChild(routerHotspot);
}

function startPacketAnimation() {
  showNotification('üì¶ Starting packet animation...', 'success');
  // Simulate LED pattern for packet flow
  fetch('/start?hz=2');
  setTimeout(() => {
    fetch('/stop');
    showNotification('üì¶ Packet animation complete', 'success');
  }, 3000);
}

// Initialize diagram when page loads
document.addEventListener('DOMContentLoaded', () => {
  // Set default values for SNMP inputs
  const ro = document.getElementById('snmp_ro');
  const rw = document.getElementById('snmp_rw');
  if (ro && !ro.value) ro.value = 'community';
  if (rw && !rw.value) rw.value = 'private';
  
  // Initialize the network diagram
  initializeDiagram();
});

// Enhanced tab switching to handle diagram
function showTab(tabName, clickedElement) {
  // Hide all panels
  const panels = document.querySelectorAll('.panel');
  panels.forEach(panel => panel.style.display = 'none');
  
  // Remove active class from all tabs
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => tab.classList.remove('active'));
  
  // Show selected panel
  const selectedPanel = document.getElementById(tabName);
  if (selectedPanel) {
    selectedPanel.style.display = 'flex';
  }
  
  // Add active class to clicked tab
  if (clickedElement) {
    clickedElement.classList.add('active');
  }
  
  // Initialize diagram when switching to it
  if (tabName === 'diagram') {
    setTimeout(() => {
      showNotification('üåê Network diagram loaded', 'success');
    }, 300);
  }
}
</script>
</body>
</html>
